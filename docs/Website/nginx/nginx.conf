user  nginx;
worker_processes  auto;
worker_cpu_affinity auto;

error_log  /var/log/nginx/error.log notice;
pid        /var/run/nginx.pid;

# worker进程最大打开文件数
worker_rlimit_nofile 80000;

# 事件处理模型优化
events {
    # 设置work_connections 连接数
    worker_connections  65535;
    use epoll;
}


http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # 访问日志配置
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    # nginx优化 ##################################################################################
   
    # 隐藏版本号 (隐藏Nginx版本号，避免安全漏洞泄漏)
    server_tokens off;

    # 关闭列表访问
    autoindex off;

    # 优化服务器域名的散列表大小 (配置多个 server 虚拟主机，所必需)
    # server_names_hash_bucket_size 64;
    # server_names_hash_max_size 2048;

    # 开启高效文件传输模式
    sendfile        on;
    # 减少网络报文段数量
    # tcp_nopush on;
    # 提高I/O性能 (需要在sendfile开启模式才有效，防止网路阻塞，积极的减少网络报文段的数量。将响应头和正文的开始部分一起发送，而不一个接一个的发送。)
    tcp_nopush      on;

    # 连接超时 时间定义 默认秒 默认65秒
    keepalive_timeout  20;

    # 读取客户端请求头数据的超时时间 默认秒 默认60秒
    client_header_timeout 15;

    # 读取客户端请求主体的超时时间 默认秒 默认60秒
    client_body_timeout 15;

    # 响应客户端的超时时间 默认秒 默认60秒
    send_timeout 25;

    # 指定的缓冲区
    client_header_buffer_size 32k;
    client_body_buffer_size 1024k;
    large_client_header_buffers 4 32k;


    # 上传文件的大小限制  默认1m
    client_max_body_size    50m;

    # GZIP压缩性能优化
    gzip on;       #表示开启压缩功能
    gzip_min_length  1k; #表示允许压缩的页面最小字节数，页面字节数从header头的Content-Length中获取。默认值是0，表示不管页面多大都进行压缩，建议设置成大于1K。如果小于1K可能会越压越大
    gzip_buffers     4 32k; #压缩缓存区大小
    gzip_http_version 1.1; #压缩版本
    gzip_comp_level 6; #压缩比率， 一般选择4-6，为了性能gzip_types text/css text/xml application/javascript;　　#指定压缩的类型 gzip_vary on;　#vary header支持



    #  ##################################################################################
    server {
        # SSL 默认访问端口号为 443
        listen 443 ssl;
        # 填写绑定证书的域名
        server_name www.mmdz.cloud;
	    underscores_in_headers on;
        # 启用SSL功能
 	    #ssl on;
        # 根据实际的路径和文件名配置
        ssl_certificate /usr/local/software/nginx/cert/server.pem; 
        # 根据实际的路径和文件名配置
        ssl_certificate_key /usr/local/software/nginx/cert/server.key; 
        ssl_session_timeout     5m;
        # 按照这个协议配
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2; 
        # 按照这个套件配
        ssl_ciphers  ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;
        ssl_prefer_server_ciphers   on;
        ssl_session_cache shared:SSL:1m;

        # 禁止在header中出现服务器版本，防止黑客利用版本漏洞攻击
        server_tokens off;
        
        location / {
            # if (!-e $request_filename){
            #     rewrite ^/(.*) /index.html last;
            #     break;
            # }
            # 网站主页路径。此路径仅供参考，具体请您按照实际目录操作。
            # 站点目录，例如，您的网站主页在 Nginx 服务器的 /etc/www 目录下，则请修改 root 后面的 html 为 /etc/www。
            # root   /usr/local/software/nginx/html; 

            root   /usr/share/nginx/html;
            index  index.html index.htm;
        }

        location /vpn/ {
            proxy_connect_timeout 600;
            proxy_send_timeout 600;
            proxy_read_timeout 600;
           # proxy_set_header Host $host;
           # proxy_set_header X-Real-IP $remote_addr;
           # proxy_set_header REMOTE-HOST $remote_addr;
           # proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_pass http://10.40.49.180:54321/vpn/;
        }

        location /bolg/ {
            proxy_connect_timeout 600;
            proxy_send_timeout 600;
            proxy_read_timeout 600;
            # proxy_set_header Host $host;
            # proxy_set_header X-Real-IP $remote_addr;
            # proxy_set_header REMOTE-HOST $remote_addr;
            # proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_pass http://10.40.49.180:3000/;
        }

        # nginx并发量面板
        location /status {
            stub_status on;
        }

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   /usr/share/nginx/html;
        }
    }

    #  ##################################################################################
    server {
        # SSL 默认访问端口号为 443
        listen 443 ssl;
        # 填写绑定证书的域名
        server_name cloudreve.mmdz.cloud;
	    underscores_in_headers on;
        # 启用SSL功能
 	    #ssl on;
        # 根据实际的路径和文件名配置
        ssl_certificate /usr/local/software/nginx/cert/cloudreve/server.pem; 
        # 根据实际的路径和文件名配置
        ssl_certificate_key /usr/local/software/nginx/cert/cloudreve/server.key; 
        ssl_session_timeout     5m;
        # 按照这个协议配
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2; 
        # 按照这个套件配
        ssl_ciphers  ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;
        ssl_prefer_server_ciphers   on;
        ssl_session_cache shared:SSL:1m;

        # 禁止在header中出现服务器版本，防止黑客利用版本漏洞攻击
        server_tokens off;

        location / {
            proxy_connect_timeout 600;
            proxy_send_timeout 600;
            proxy_read_timeout 600;
            # proxy_set_header Host $host;
            # proxy_set_header X-Real-IP $remote_addr;
            # proxy_set_header REMOTE-HOST $remote_addr;
            # proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_pass http://10.40.49.180:5212/;
        }

        # nginx并发量面板
        location /status {
            stub_status on;
        }

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   /usr/share/nginx/html;
        }
    }

    # 默认配置
    include /etc/nginx/conf.d/*.conf;
}

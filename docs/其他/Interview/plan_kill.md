# 秒杀系统

## 秒杀微服务

> 把秒杀商品压入redis缓存来提升访问效率（高并发场景），秒杀商品通常有两种限制：**库存限制**、**时间限制**。
>
> 1. 秒杀频道数据（一个时间段可以有多个面纱商品）
> 2. 秒杀详情页数据（秒杀详情页）
> 3. 定时将秒杀商品存入redis缓存中

`需求`

> 1. 录入秒杀商品数据，主要包括：商品标题、原价、秒杀价、商品图片、介绍、秒杀时段等信息
> 2. 秒杀频道首页列出秒杀商品（进行中的）点击秒杀商品图片跳转到秒杀商品详细页。
> 3. 商品详细页显示秒杀商品信息，点击立即抢购实现秒杀下单，下单时扣减库存。当库存为0或不在活动期范围内时无法秒杀。
> 4. 秒杀下单成功，直接跳转到支付页面（微信扫码），支付成功，跳转到成功页，填写收货地址、电话、收件人等信息，完成订单。
> 5. 当用户秒杀下单5分钟内未支付，取消预订单，调用微信支付的关闭订单接口，恢复库存。
> 6. 设计到的表  seckill_goods（秒杀表）  seckill_order（秒杀订单表） 通过秒杀表主键id和秒杀订单表seckill_id 进行关联 

`场景`

> 我们现场要卖 1000 台 iPhone14 pro，然后我们根据以往这样秒杀活动的数据经验来看，目测来抢这 1000 台 iPhone4 pro 的人足足有 50w 人。

`问题`

> - `高并发`：秒杀的特点就是这样**时间极短**、 **瞬间用户量大**
> - `超卖`：
> - `恶意请求`：脚本
> - `链接暴露`：下单地址被知道
> - `数据库`：每秒上万甚至十几万的**QPS**（每秒请求数）直接打到**数据库**

## 秒杀系统图

![](plan_imgs\640.jpg)

> 1. 秒杀商品入库审核（后台），把秒杀商品保存到mysql中
>
> 2. 秒杀服务定时将秒杀商品载入redis
>
> 3. 获取秒杀列表页（展示秒杀商品）
>
>    **前端限流**
>
>    - 页面静态化：活动页面绝大多数内容是固定的，比如：商品名称、商品描述、图片等。为了减少不必要的服务端请求，通常情况下，会对活动页面做`静态化`处理。
>
>    - CDN：但只做页面静态化还不够，因为用户分布在全国各地，有些人在北京，有些人在成都，有些人在深圳，地域相差很远，网速各不相同。
>      *使用户就近获取所需内容，降低网络拥塞，提高用户访问响应速度和命中率。*
>
>    - 预约通知（业务形式的限流）：
>
>      秒杀前一周提前预约，并生成一个 token 存放在用户浏览器中，只有通过 token 才可以访问后台；并且可以通过预约知道该秒杀商品的抢购人数，可以采用一些规则去限流人数（例如：预约的人、会员、完成活动的用户……）
>
>    - 验证码（用户体验不友好）：
>
>      用户在请求之前，需要先输入验证码。加验证码的方式可能更精准一些，同样能限制用户的访问频次，但好处是不会存在误杀的情况。
>
>    - 秒杀按钮：
>
>      前端还可以加一个定时器，控制比如：10秒之内，只允许发起一次请求。如果用户点击了一次秒杀按钮，则在10秒之内置灰，不允许再次点击，等到过了时间限制，又允许重新点击该按钮。
>
>    - 动态url：
>
>      把**URL动态化**，通过MD5之类的摘要算法加密随机的字符串去做url，然后通过前端代码获取url后台校验才能通过。
>
> 4. 网关
>
>    可以使用：ngnix、getway、zuul
>
>    **限流方法**
>
>    - 黑名单（大数据分析出的恶意用户或IP有问题的）
>
>    - 对同一个 IP 或 ID 发出的重复请求拒绝
>
>      redis 集群计数，考虑到 redis 的带宽和性能瓶颈，可能就需要考虑做分片；或者使用二级缓存、JVM内存里统计计数也是可以的（但是在网关集群下，负载均衡时，可能会存在统计计数差异）。也可以使用 redis 的高级数据结构 Bitmaps 实现布隆过滤器，提前加载预约的用户，对不存在的 IP 或 ID 发出的重复请求拒绝；
>
>    - 拦截没有 预约token 的请求，这些请求可能通过其他方式进来的，所以直接拒绝
>
> 5. 秒杀服务
>
> 6. 用户可以主动查询订单状态，查询redis（提供主动查询接口）
>
> 7. 抢单成功后会通过rabbitmq（集群）发送一个消息发送给延时队列发送订单id，用户id，秒杀商品id，延时5分钟，目的是处理未支付订单
>
> 8. 5分钟后监听rabbitMQ监听延迟队列，通过rabbitmq发来的消息查询redis对应的订单，订单如果存在则表示没有支付，需要关闭支付（微信），回滚redis中的库存，删除redis中清单排队信息
>
> 9. 抢单成功进入调用支付服务，进行付款，支付成功后会删除redis相关数据，删除订单信息，删除排队信息，同时把数据同步到mysql
>
> 10. 秒杀时间段内没有买完秒杀商品，则需要把redis中剩余库存数量的商品，同步到mysql中

![](plan_imgs\20201103113427398.png)

